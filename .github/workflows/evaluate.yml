name: Optimized Evaluation

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  evaluate:
    runs-on: ubuntu-latest
    container: python:3.13-slim
    permissions:
      contents: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v4



    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install polars numpy pyarrow kaggle requests

    - name: Download ground truth data
      env:
        KAGGLE_API_TOKEN: ${{ secrets.KAGGLE_KEY }}
        # If running locally or without Kaggle API, you might need another way to fetch data.
        # But for GitHub Actions, secrets are required.
      run: |
        apt-get update && apt-get install -y unzip
        mkdir -p data
        kaggle competitions download -c ts-forecasting
        unzip -o ts-forecasting.zip -d data/
        rm ts-forecasting.zip

    - name: Run Evaluation
      id: evaluation
      run: |
        # Determine which submission file to use
        if [ -f "validation_results.csv" ]; then
          SUB_FILE="validation_results.csv"
          echo "Found Validation File: Using real holdout scoring."
        elif [ -f "submission_optimized.csv" ]; then
          SUB_FILE="submission_optimized.csv"
          echo "Found Test Submission: Using proxy benchmark scoring."
        else
          echo "Error: No submission or validation file found"
          exit 1
        fi

        echo "Evaluating: $SUB_FILE"
        python evaluate.py "$SUB_FILE" | tee evaluation_results.txt

    - name: Generate Job Summary
      if: always()
      run: |
        echo "# ðŸ“Š Evaluation Report" >> $GITHUB_STEP_SUMMARY
        
        # Extract Score (Updated for new output format: "Overall Skill Score | 0.99...")
        SCORE=$(grep "Overall Skill Score" evaluation_results.txt | cut -d'|' -f2 | xargs)
        
        if [ ! -z "$SCORE" ]; then
          echo "## ðŸ† Overall Skill Score: **$SCORE**" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Detailed Metrics" >> $GITHUB_STEP_SUMMARY
        echo '```text' >> $GITHUB_STEP_SUMMARY
        cat evaluation_results.txt >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
